---
import { isActivePath, navLinks, normalizePath, residentLinks } from "../utils/navigation";

const pathname = normalizePath(Astro.url.pathname);
---

<nav class="fixed start-0 top-0 z-50 w-full border-b border-slate-200 bg-white shadow-sm">
  <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between px-4 py-3">
    <a href="/" class="flex items-center gap-2">
      <span class="material-symbols-outlined text-primary text-3xl">home</span>
      <span class="text-lg font-semibold text-slate-900">First Ballston Commons</span>
    </a>
    <button
      id="nav-toggle"
      type="button"
      class="hover:text-primary focus:ring-primary/40 inline-flex h-10 w-10 items-center justify-center rounded-lg p-2 text-slate-700 hover:bg-slate-100 focus:ring-2 focus:outline-none lg:hidden"
      aria-controls="nav-menu"
      aria-expanded="false"
    >
      <span class="sr-only">Open main menu</span>
      <span class="material-symbols-outlined">menu</span>
    </button>
    <div class="hidden w-full lg:block lg:w-auto" id="nav-menu">
      <ul
        class="mt-4 flex flex-col rounded-xl border border-slate-200 bg-slate-50 p-4 font-medium lg:mt-0 lg:flex-row lg:items-center lg:space-x-6 lg:border-0 lg:bg-transparent"
      >
        {
          navLinks.map((link) => {
            const isActive = isActivePath(pathname, link.href);
            return (
              <li>
                <a
                  class={`block rounded px-3 py-2 lg:p-0 ${
                    isActive
                      ? "text-primary font-semibold"
                      : "lg:hover:text-primary text-slate-700 hover:bg-slate-100 lg:hover:bg-transparent"
                  }`}
                  href={link.href}
                >
                  {link.label}
                </a>
              </li>
            );
          })
        }
        <li class="relative">
          <button
            id="residents-toggle"
            type="button"
            class="lg:hover:text-primary flex w-full items-center gap-1 rounded px-3 py-2 font-semibold text-slate-700 hover:bg-slate-100 lg:p-0 lg:font-medium lg:hover:bg-transparent"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="residents-menu"
          >
            For Residents
            <span class="material-symbols-outlined text-base">expand_more</span>
          </button>
          <div id="residents-menu" class="mt-2 hidden lg:absolute lg:left-0 lg:mt-3 lg:w-64">
            <div
              class="space-y-1 rounded-xl border border-slate-200 bg-white p-2 shadow-lg shadow-slate-200/70"
            >
              {
                residentLinks.map((link) => (
                  <a
                    class={`block rounded-lg px-3 py-2 hover:bg-slate-100 ${
                      isActivePath(pathname, link.href)
                        ? "text-primary font-semibold lg:font-medium"
                        : "text-slate-700"
                    } ${link.external ? "inline-flex w-full items-center gap-2" : ""}`}
                    href={link.href}
                    target={link.external ? "_blank" : undefined}
                    rel={link.external ? "noopener" : undefined}
                  >
                    {link.label}
                    {link.external && (
                      <span class="material-symbols-outlined text-base">open_in_new</span>
                    )}
                  </a>
                ))
              }
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  const toggle = document.getElementById("nav-toggle");
  const menu = document.getElementById("nav-menu");
  const residentsToggle = document.getElementById("residents-toggle");
  const residentsMenu = document.getElementById("residents-menu");

  if (toggle && menu) {
    const setResidentsOpen = (isOpen: boolean) => {
      if (!residentsMenu || !residentsToggle) return;
      residentsMenu.classList.toggle("hidden", !isOpen);
      residentsToggle.setAttribute("aria-expanded", String(isOpen));
    };

    const setMenuOpen = (open: boolean) => {
      const shouldOpen = open || window.innerWidth >= 1024;
      menu.classList.toggle("hidden", !shouldOpen);
      toggle.setAttribute("aria-expanded", String(shouldOpen));
      if (!shouldOpen) setResidentsOpen(false);
    };

    toggle.addEventListener("click", () => {
      const isOpen = menu.classList.contains("hidden");
      setMenuOpen(isOpen);
    });

    if (residentsToggle && residentsMenu) {
      residentsToggle.addEventListener("click", (event) => {
        event.stopPropagation();
        const isOpen = !residentsMenu.classList.contains("hidden");
        setResidentsOpen(!isOpen);
      });

      document.addEventListener("click", (event) => {
        const target = event.target as Node | null;
        if (
          residentsMenu.classList.contains("hidden") ||
          (target && (residentsMenu.contains(target) || residentsToggle.contains(target)))
        ) {
          return;
        }
        setResidentsOpen(false);
      });
    }

    window.addEventListener("resize", () => setMenuOpen(window.innerWidth >= 1024));
    setMenuOpen(window.innerWidth >= 1024);
  }
</script>
